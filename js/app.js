import { CONFIG, ETF_DATA, ETF_LIST } from './config.js';
import { debug } from './debug.js';
import { api } from './api.js';
import { ui } from './ui.js';
import { trading } from './trading.js';
import { notifications } from './notifications.js';

// Application principale
class TradingApp {
    constructor() {
        this.state = {
            isInitialized: false,
            isRefreshing: false,
            autoRefreshInterval: null,
            lastAnalysis: null,
            errorCount: 0,
            successfulRefreshes: 0
        };
        
        this.init();
    }

    async init() {
        try {
            debug.startSection('INITIALISATION APPLICATION');
            
            // Initialisation des modules
            await this.initializeModules();
            
            // Configuration des √©couteurs d'√©v√©nements
            this.setupEventListeners();
            
            // Configuration du trading
            this.setupTradingCallbacks();
            
            // Test initial des notifications
            await this.initializeNotifications();
            
            // Interface utilisateur initiale
            this.initializeUI();
            
            this.state.isInitialized = true;
            debug.success('‚úÖ Application initialis√©e avec succ√®s');
            debug.endSection('INITIALISATION APPLICATION');
            
            // Message de bienvenue
            this.showWelcomeMessage();
            
        } catch (error) {
            debug.error(`Erreur d'initialisation: ${error.message}`);
            this.handleCriticalError(error);
        }
    }

    // Initialisation des modules
    async initializeModules() {
        debug.info('Initialisation des modules...');
        
        // Tous les modules sont d√©j√† initialis√©s via leurs imports
        // V√©rifier leur √©tat
        const moduleStats = {
            debug: debug.stats(),
            api: api.stats(),
            ui: ui.getState(),
            trading: trading.getStats(),
            notifications: notifications.getStats()
        };
        
        debug.info('√âtat des modules:', JSON.stringify(moduleStats, null, 2));
    }

    // Configuration des √©couteurs d'√©v√©nements
    setupEventListeners() {
        debug.info('Configuration des √©couteurs d\'√©v√©nements...');
        
        // √âv√©nements UI
        document.addEventListener('refresh-requested', () => {
            this.handleRefreshRequest();
        });
        
        document.addEventListener('test-connection-requested', () => {
            this.handleConnectionTest();
        });
        
        document.addEventListener('stock-changed', (event) => {
            this.handleStockChange(event.detail.newStock);
        });
        
        document.addEventListener('portfolio-changed', (event) => {
            this.handlePortfolioChange(event.detail.newValue);
        });

        // √âv√©nements navigateur
        window.addEventListener('beforeunload', () => {
            this.cleanup();
        });

        window.addEventListener('visibilitychange', () => {
            this.handleVisibilityChange();
        });

        // √âv√©nements r√©seau
        window.addEventListener('online', () => {
            this.handleNetworkChange(true);
        });

        window.addEventListener('offline', () => {
            this.handleNetworkChange(false);
        });
    }

    // Configuration des callbacks de trading
    setupTradingCallbacks() {
        debug.info('Configuration des callbacks de trading...');
        
        // Callback pour les nouveaux signaux de trade
        trading.onSignal((recommendation) => {
            this.handleTradeSignal(recommendation);
        });
    }

    // Initialisation des notifications
    async initializeNotifications() {
        debug.info('Initialisation des notifications...');
        
        try {
            const hasPermission = await notifications.requestPermission();
            if (hasPermission) {
                debug.success('Permissions notifications accord√©es');
            } else {
                debug.warning('Permissions notifications refus√©es - utilisation fallback');
            }
        } catch (error) {
            debug.warning(`Erreur initialisation notifications: ${error.message}`);
        }
    }

    // Initialisation de l'interface utilisateur
    initializeUI() {
        debug.info('Initialisation de l\'interface utilisateur...');
        ui.render();
    }

    // Message de bienvenue
    showWelcomeMessage() {
        const features = notifications.checkFeatures();
        const hasAdvancedFeatures = features.actions && features.vibrate;
        
        let message = 'üéâ Trading App initialis√©e !\n\n';
        message += '‚úÖ API B√∂rse Frankfurt configur√©e\n';
        message += `‚úÖ ${ETF_LIST.length} ETFs disponibles\n`;
        message += `‚úÖ Seuil de trading: ${CONFIG.TRADING_THRESHOLD}%\n`;
        message += `‚úÖ Notifications ${notifications.isEnabled() ? 'activ√©es' : 'disponibles'}\n`;
        
        if (hasAdvancedFeatures) {
            message += '‚úÖ Fonctionnalit√©s avanc√©es disponibles\n';
        }
        
        message += '\nüí° Cliquez "Test Connexion" pour commencer !';
        
        setTimeout(() => {
            notifications.show(
                'üöÄ B√∂rse Trading Ready!',
                message,
                'success',
                { requireInteraction: true }
            );
        }, 1000);
    }

    // Gestion de la demande de rafra√Æchissement
    async handleRefreshRequest() {
        if (this.state.isRefreshing) {
            debug.warning('Rafra√Æchissement d√©j√† en cours - ignor√©');
            return;
        }

        debug.startSection('RAFRA√éCHISSEMENT DEMAND√â');
        this.state.isRefreshing = true;
        ui.updateRefreshButton(true);

        try {
            // R√©cup√©ration des donn√©es
            const result = await api.fetchAll(ETF_LIST);
            
            // Mise √† jour des donn√©es ETF
            Object.keys(result.results).forEach(etf => {
                Object.assign(ETF_DATA[etf], result.results[etf]);
            });

            // Mise √† jour de l'interface
            ui.render();
            ui.updateLastRefresh();

            // Analyse de trading
            const analysis = trading.analyze(ui.getCurrentStock(), ui.getPortfolioValue());
            this.state.lastAnalysis = analysis;

            // Affichage des recommandations
            if (analysis.recommendation) {
                ui.showRecommendations(analysis.recommendation, analysis.deltas);
            } else {
                ui.hideRecommendations();
            }

            // Statistiques
            this.state.successfulRefreshes++;
            this.state.errorCount = 0;

            // Notification de succ√®s
            if (result.successCount === result.totalCount) {
                notifications.showUpdate(result.successCount, result.totalCount);
                debug.success(`‚úÖ Rafra√Æchissement complet: ${result.successCount}/${result.totalCount} ETFs`);
                
                // D√©marrer l'auto-refresh si tous les ETFs sont r√©cup√©r√©s
                this.setupAutoRefresh();
            } else {
                debug.warning(`‚ö†Ô∏è Rafra√Æchissement partiel: ${result.successCount}/${result.totalCount} ETFs`);
            }

        } catch (error) {
            debug.error(`Erreur lors du rafra√Æchissement: ${error.message}`);
            this.handleRefreshError(error);
        } finally {
            this.state.isRefreshing = false;
            ui.updateRefreshButton(false);
            debug.endSection('RAFRA√éCHISSEMENT');
        }
    }

    // Gestion du test de connexion
    async handleConnectionTest() {
        debug.startSection('TEST DE CONNEXION');
        
        try {
            const testResult = await api.test();
            
            if (testResult.success) {
                ui.showMessage(testResult.message, 'success');
                notifications.show(
                    '‚úÖ Connexion R√©ussie',
                    'API B√∂rse Frankfurt accessible - pr√™t pour le trading !',
                    'success'
                );
            } else {
                ui.showMessage(testResult.message, 'error');
                notifications.showError(new Error(testResult.error));
            }
            
        } catch (error) {
            debug.error(`Erreur test de connexion: ${error.message}`);
            ui.showMessage(`Erreur test: ${error.message}`, 'error');
        } finally {
            debug.endSection('TEST DE CONNEXION');
        }
    }

    // Gestion du changement d'ETF
    handleStockChange(newStock) {
        debug.info(`Changement d'ETF vers: ${newStock}`);
        
        // R√©analyse imm√©diate si on a des donn√©es
        if (this.hasValidData()) {
            this.performTradingAnalysis();
        }
    }

    // Gestion du changement de valeur du portefeuille
    handlePortfolioChange(newValue) {
        debug.info(`Changement valeur portefeuille: ${newValue}‚Ç¨`);
        
        // R√©analyse imm√©diate si on a des donn√©es
        if (this.hasValidData()) {
            this.performTradingAnalysis();
        }
    }

    // Gestion des signaux de trading
    handleTradeSignal(recommendation) {
        debug.success(`üö® NOUVEAU SIGNAL DE TRADE: ${recommendation.fromETF} ‚Üí ${recommendation.toETF}`);
        
        // Notification push
        notifications.showTradeSignal(recommendation);
        
        // Log d√©taill√©
        debug.info(`Delta: +${recommendation.delta.toFixed(2)}%`);
        debug.info(`Gain potentiel: +${recommendation.potentialGain.toFixed(0)}‚Ç¨`);
        debug.info(`Gain net: +${recommendation.netGain.toFixed(0)}‚Ç¨`);
        debug.info(`Confiance: ${recommendation.confidence.toFixed(1)}%`);
        
        // Mise √† jour UI avec animation
        const recSection = document.getElementById('recommendation-section');
        if (recSection) {
            recSection.classList.add('animate-pulse');
            setTimeout(() => {
                recSection.classList.remove('animate-pulse');
            }, 3000);
        }
    }

    // Analyse de trading
    performTradingAnalysis() {
        if (!this.hasValidData()) {
            debug.warning('Analyse trading impossible - donn√©es insuffisantes');
            return;
        }

        const analysis = trading.analyze(ui.getCurrentStock(), ui.getPortfolioValue());
        this.state.lastAnalysis = analysis;

        // Mise √† jour de l'interface
        if (analysis.recommendation) {
            ui.showRecommendations(analysis.recommendation, analysis.deltas);
        } else {
            ui.hideRecommendations();
        }

        debug.info('Analyse de trading termin√©e');
    }

    // V√©rification de la validit√© des donn√©es
    hasValidData() {
        const currentStock = ui.getCurrentStock();
        const stockData = ETF_DATA[currentStock];
        
        return stockData && 
               stockData.price !== null && 
               stockData.changePercent !== null;
    }

    // Configuration de l'auto-refresh
    setupAutoRefresh() {
        // Annuler l'ancien interval s'il existe
        if (this.state.autoRefreshInterval) {
            clearInterval(this.state.autoRefreshInterval);
        }

        // Nouveau interval
        this.state.autoRefreshInterval = setInterval(() => {
            if (!this.state.isRefreshing && document.visibilityState === 'visible') {
                debug.info('Auto-refresh d√©clench√©');
                this.handleRefreshRequest();
            }
        }, CONFIG.AUTO_REFRESH_INTERVAL);

        debug.success(`Auto-refresh configur√© (${CONFIG.AUTO_REFRESH_INTERVAL / 60000} minutes)`);
    }

    // Gestion des erreurs de rafra√Æchissement
    handleRefreshError(error) {
        this.state.errorCount++;
        
        if (error.message.includes('CORS')) {
            notifications.show(
                '‚ö†Ô∏è Probl√®me CORS',
                'Utilisez une extension CORS ou Chrome en mode d√©veloppeur',
                'warning'
            );
        } else if (error.message.includes('Failed to fetch')) {
            notifications.show(
                '‚ùå Erreur R√©seau',
                'V√©rifiez votre connexion internet',
                'error'
            );
        } else {
            notifications.showError(error);
        }

        // Arr√™ter l'auto-refresh apr√®s trop d'erreurs
        if (this.state.errorCount >= 3) {
            this.stopAutoRefresh();
            debug.warning('Auto-refresh arr√™t√© apr√®s 3 erreurs cons√©cutives');
        }
    }

    // Gestion des erreurs critiques
    handleCriticalError(error) {
        debug.error(`ERREUR CRITIQUE: ${error.message}`);
        
        notifications.show(
            'üí• Erreur Critique',
            `L'application a rencontr√© une erreur: ${error.message}`,
            'error',
            { requireInteraction: true }
        );

        // Tenter une r√©initialisation
        setTimeout(() => {
            this.attemptRecovery();
        }, 5000);
    }

    // Tentative de r√©cup√©ration
    attemptRecovery() {
        debug.info('Tentative de r√©cup√©ration...');
        
        try {
            // Reset des modules
            trading.reset();
            api.reset();
            
            // Nettoyage de l'√©tat
            this.state.errorCount = 0;
            this.state.isRefreshing = false;
            
            // R√©initialisation UI
            ui.forceUpdate();
            
            debug.success('R√©cup√©ration r√©ussie');
            notifications.show(
                'üîÑ R√©cup√©ration',
                'L\'application a √©t√© r√©initialis√©e avec succ√®s',
                'success'
            );
            
        } catch (recoveryError) {
            debug.error(`√âchec de la r√©cup√©ration: ${recoveryError.message}`);
        }
    }

    // Gestion du changement de visibilit√©
    handleVisibilityChange() {
        if (document.visibilityState === 'visible') {
            debug.info('Application redevenue visible');
            // Optionnel: refresh si absent longtemps
        } else {
            debug.info('Application masqu√©e');
        }
    }

    // Gestion du changement de r√©seau
    handleNetworkChange(isOnline) {
        if (isOnline) {
            debug.success('Connexion internet r√©tablie');
            notifications.show(
                'üåê Connexion R√©tablie',
                'Vous pouvez reprendre les mises √† jour',
                'success'
            );
            
            // Red√©marrer l'auto-refresh si arr√™t√©
            if (!this.state.autoRefreshInterval && this.state.successfulRefreshes > 0) {
                this.setupAutoRefresh();
            }
        } else {
            debug.warning('Connexion internet perdue');
            notifications.show(
                'üîå Hors Ligne',
                'Les mises √† jour sont temporairement indisponibles',
                'warning'
            );
            this.stopAutoRefresh();
        }
    }

    // Arr√™t de l'auto-refresh
    stopAutoRefresh() {
        if (this.state.autoRefreshInterval) {
            clearInterval(this.state.autoRefreshInterval);
            this.state.autoRefreshInterval = null;
            debug.info('Auto-refresh arr√™t√©');
        }
    }

    // Nettoyage avant fermeture
    cleanup() {
        debug.info('Nettoyage de l\'application...');
        
        this.stopAutoRefresh();
        notifications.closeAll();
        
        // Sauvegarder les donn√©es de performance
        try {
            const performanceData = trading.export();
            localStorage.setItem('trading-performance', JSON.stringify(performanceData));
        } catch (error) {
            debug.warning('Impossible de sauvegarder les donn√©es de performance');
        }
    }

    // Statistiques de l'application
    getAppStats() {
        return {
            state: { ...this.state },
            modules: {
                debug: debug.stats(),
                api: api.stats(),
                ui: ui.getState(),
                trading: trading.getStats(),
                notifications: notifications.getStats()
            },
            performance: trading.getPerformance(),
            uptime: Date.now() - (this.state.initTimestamp || Date.now())
        };
    }

    // Export des donn√©es pour analyse
    exportAppData() {
        const appData = {
            version: '1.0.0',
            timestamp: new Date().toISOString(),
            stats: this.getAppStats(),
            config: CONFIG,
            etfData: ETF_DATA,
            logs: debug.export ? debug.export() : 'Non disponible'
        };

        const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `trading-app-export-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        debug.success('Donn√©es de l\'application export√©es');
    }
}

// Initialisation de l'application au chargement du DOM
document.addEventListener('DOMContentLoaded', () => {
    // Cr√©er l'instance globale de l'application
    window.tradingApp = new TradingApp();
    
    // Fonctions globales pour le d√©bogage (disponibles dans la console)
    window.debugApp = {
        stats: () => window.tradingApp.getAppStats(),
        export: () => window.tradingApp.exportAppData(),
        refresh: () => window.tradingApp.handleRefreshRequest(),
        test: () => window.tradingApp.handleConnectionTest(),
        recovery: () => window.tradingApp.attemptRecovery(),
        notifications: notifications,
        debug: debug,
        api: api,
        ui: ui,
        trading: trading
    };
    
    console.log('üöÄ Trading App charg√©e ! Utilisez window.debugApp pour le d√©bogage.');
});

export default TradingApp;