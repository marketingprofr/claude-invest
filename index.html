<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil de Trading Automatis√© - B√∂rse Frankfurt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        #debug-content {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-size: 11px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <!-- Header -->
            <header class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <i data-lucide="calculator" class="w-8 h-8 text-blue-600 mr-3"></i>
                    <h1 class="text-3xl font-bold text-gray-800">Trading Automatis√© - B√∂rse Frankfurt</h1>
                </div>
                <p class="text-gray-600">Donn√©es ETF en temps r√©el depuis B√∂rse Frankfurt</p>
                <div class="mt-2 flex items-center justify-center">
                    <div class="text-sm text-blue-600 bg-blue-50 px-4 py-2 rounded-lg">
                        üìÖ <span id="current-date"></span>
                    </div>
                </div>
            </header>

            <!-- Configuration -->
            <div class="mb-8 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 border border-green-200">
                <h2 class="text-lg font-semibold mb-4 text-green-800">üèõÔ∏è Configuration B√∂rse Frankfurt</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ETF D√©tenu</label>
                        <select id="current-stock" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-lg font-semibold">
                            <option value="IWDA">IWDA (iShares Core MSCI World)</option>
                            <option value="VWCE" selected>VWCE (Vanguard FTSE All-World)</option>
                            <option value="MEUD">MEUD (Amundi STOXX Europe 600)</option>
                            <option value="IMAE">IMAE (iShares Core MSCI Europe)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valeur Portefeuille (‚Ç¨)</label>
                        <input
                            type="number"
                            id="portfolio-value"
                            value="100000"
                            class="w-full p-3 border border-gray-300 rounded-lg text-lg font-semibold"
                        />
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex space-x-4">
                        <button
                            id="refresh-btn"
                            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:opacity-50 flex items-center font-semibold"
                        >
                            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                            Actualiser les Cours
                        </button>
                        
                        <button
                            id="test-connection-btn"
                            class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center"
                        >
                            <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                            Test Connexion
                        </button>
                    </div>
                    
                    <div id="last-refresh" class="text-sm text-gray-600"></div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-blue-800 text-sm">
                        ‚ÑπÔ∏è <strong>Source de donn√©es:</strong> API B√∂rse Frankfurt (api.boerse-frankfurt.de)
                        <br>‚Ä¢ API publique gratuite - pas de cl√© requise
                        <br>‚Ä¢ Cours ETF en temps r√©el pendant les heures de march√©
                        <br>‚Ä¢ Mise √† jour automatique toutes les 15 minutes
                        <br>‚Ä¢ URL API: https://api.boerse-frankfurt.de/v1/data/quote_box/single?isin=...
                    </p>
                </div>
                
                <div id="debug-info" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">üîç Informations de d√©bogage</h4>
                    <div id="debug-content" class="text-sm text-gray-700 font-mono"></div>
                    <button id="toggle-debug" class="mt-2 text-blue-600 hover:underline text-sm">Afficher/Masquer logs</button>
                </div>
            </div>

            <!-- Tableau des cours -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-green-600"></i>
                    Cours en Temps R√©el - B√∂rse Frankfurt
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                                <th class="border border-gray-300 px-4 py-3 text-left">ETF</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Prix Actuel (‚Ç¨)</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Variation Journali√®re</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Delta vs <span id="header-current-stock">VWCE</span></th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Derni√®re MAJ</th>
                            </tr>
                        </thead>
                        <tbody id="etf-table-body">
                            <!-- Contenu g√©n√©r√© dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Recommandations -->
            <div id="recommendation-section" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-2 text-orange-600"></i>
                    Signal de Trading Automatique
                </h2>
                <div id="recommendation-content">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            </div>

            <!-- Analyse des deltas -->
            <div id="deltas-section" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">Analyse Temps R√©el des Opportunit√©s</h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                                <th class="border border-gray-300 px-4 py-3 text-left">Rang</th>
                                <th class="border border-gray-300 px-4 py-3 text-left">√âchange</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Delta Actuel</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Signal</th>
                                <th class="border border-gray-300 px-4 py-3 text-center">Gain Potentiel</th>
                            </tr>
                        </thead>
                        <tbody id="deltas-table-body">
                            <!-- Contenu g√©n√©r√© dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="font-semibold text-green-800 mb-2">üèõÔ∏è Trading avec B√∂rse Frankfurt - Mode d'emploi</h3>
                <div class="text-green-700 text-sm space-y-2">
                    <p><strong>1.</strong> Aucune cl√© API requise - utilise l'API publique de B√∂rse Frankfurt</p>
                    <p><strong>2.</strong> Cliquez "Test Connexion" pour v√©rifier l'acc√®s √† l'API</p>
                    <p><strong>3.</strong> Si le test √©choue (CORS), utilisez Firefox ou une extension CORS</p>
                    <p><strong>4.</strong> Cliquez "Actualiser les Cours" pour r√©cup√©rer les prix r√©els</p>
                    <p><strong>5.</strong> <strong>üîî Notifications activ√©es</strong> - vous serez alert√© automatiquement des opportunit√©s !</p>
                    <p><strong>6.</strong> Suivez les signaux üöÄ : <strong>Delta > 0.5% = TRADER IMM√âDIATEMENT !</strong></p>
                </div>
                
                <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                    <p class="text-blue-800 text-sm">
                        <strong>üí° API B√∂rse Frankfurt + Notifications:</strong>
                        <br>‚Ä¢ <strong>Donn√©es r√©elles</strong> depuis l'API officielle
                        <br>‚Ä¢ <strong>Notifications navigateur</strong> pour les signaux de trade
                        <br>‚Ä¢ <strong>Alertes automatiques</strong> quand delta > 0.5%
                        <br>‚Ä¢ <strong>Calcul en temps r√©el</strong> des opportunit√©s
                        <br>‚Ä¢ <strong>Auto-refresh 15min</strong> avec surveillance continue
                    </p>
                </div>
                
                <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <p class="text-yellow-800 text-sm">
                        <strong>‚ö†Ô∏è CORS Solutions:</strong> L'API fonctionne mais les navigateurs bloquent les requ√™tes cross-origin.
                        <br><strong>Chrome:</strong> <code>chrome --disable-web-security --user-data-dir=/tmp/chrome_dev</code>
                        <br><strong>Extensions:</strong> "CORS Unblock" (Chrome) ou "CORS Everywhere" (Firefox)
                        <br><strong>Auto:</strong> L'outil essaie automatiquement des proxies CORS publics
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let etfData = {
            IWDA: { 
                isin: 'IE00B4L5Y983', 
                wkn: 'A0RPWH',
                symbol: 'EUNL',
                name: 'iShares Core MSCI World UCITS ETF', 
                price: null, 
                change: null, 
                changePercent: null, 
                lastUpdate: null 
            },
            VWCE: { 
                isin: 'IE00BK5BQT80', 
                wkn: 'A2PKXG',
                symbol: 'VWCE',
                name: 'Vanguard FTSE All-World UCITS ETF (USD) Acc', 
                price: null, 
                change: null, 
                changePercent: null, 
                lastUpdate: null 
            },
            MEUD: { 
                isin: 'LU0908500753', 
                wkn: 'LYX0Q0',
                symbol: 'LYP6',
                name: 'Amundi STOXX Europe 600 UCITS ETF Acc', 
                price: null, 
                change: null, 
                changePercent: null, 
                lastUpdate: null 
            },
            IMAE: { 
                isin: 'IE00B4K48X80', 
                wkn: 'A0RPWG',
                symbol: 'EUNK',
                name: 'iShares Core MSCI Europe UCITS ETF EUR (Acc)', 
                price: null, 
                change: null, 
                changePercent: null, 
                lastUpdate: null 
            }
        };
        
        let currentStock = 'VWCE';
        let portfolioValue = 100000;
        let isLoading = false;
        let refreshInterval = null;
        let lastTradeSignal = null; // Pour √©viter les notifications r√©p√©t√©es

        const etfs = ['IWDA', 'VWCE', 'MEUD', 'IMAE'];
        let debugLogs = [];

        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            debugLogs.push(`[${timestamp}] ${message}`);
            if (debugLogs.length > 50) debugLogs = debugLogs.slice(-50);
            
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = debugLogs.join('<br>');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('=== INITIALISATION B√ñRSE FRANKFURT ===');
            addDebugLog('Application charg√©e avec l\'API r√©elle B√∂rse Frankfurt:');
            addDebugLog('‚Ä¢ IWDA: IE00B4L5Y983 (iShares Core MSCI World)');
            addDebugLog('‚Ä¢ VWCE: IE00BK5BQT80 (Vanguard FTSE All-World)'); 
            addDebugLog('‚Ä¢ MEUD: LU0908500753 (Amundi STOXX Europe 600)');
            addDebugLog('‚Ä¢ IMAE: IE00B4K48X80 (iShares Core MSCI Europe)');
            addDebugLog('API: https://api.boerse-frankfurt.de/v1/data/quote_box/single?isin=...');
            addDebugLog('');
            addDebugLog('üéØ LOGIQUE DE TRADING:');
            addDebugLog('‚Ä¢ Variations depuis l\'ouverture du jour');
            addDebugLog('‚Ä¢ Delta = diff√©rence entre variations');
            addDebugLog('‚Ä¢ Signal d\'achat si delta > +0.5%');
            addDebugLog('');
            
            lucide.createIcons();
            updateCurrentDate();
            setupEventListeners();
            renderETFTable();
            
            // Masquer les logs par d√©faut
            document.getElementById('debug-content').style.display = 'none';
            
            addDebugLog('Pr√™t ! Testez "Test Connexion" pour v√©rifier l\'acc√®s.');
        });

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', options);
        }

        function setupEventListeners() {
            // Current stock change
            document.getElementById('current-stock').addEventListener('change', function() {
                currentStock = this.value;
                document.getElementById('header-current-stock').textContent = currentStock;
                renderETFTable();
                calculateRecommendation();
            });

            // Portfolio value change
            document.getElementById('portfolio-value').addEventListener('input', function() {
                portfolioValue = parseFloat(this.value) || 100000;
                calculateRecommendation();
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', refreshAllData);
            
            // Test connection button
            document.getElementById('test-connection-btn').addEventListener('click', testConnection);
            
            // Toggle debug info
            document.getElementById('toggle-debug').addEventListener('click', function() {
                const content = document.getElementById('debug-content');
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            });
        }

        // Fonction pour cr√©er un proxy CORS simple (simulation)
        function createCORSProxy(url) {
            // En production, utilisez un vrai service de proxy CORS
            const proxyServices = [
                'https://api.allorigins.win/get?url=',
                'https://cors-anywhere.herokuapp.com/',
                'https://api.codetabs.com/v1/proxy?quest='
            ];
            
            // Pour la d√©mo, nous simulerons les donn√©es
            return url;
        }

        async function fetchETFDataFromBoerseFrankfurt(etf) {
            addDebugLog(`R√©cup√©ration de ${etf} depuis B√∂rse Frankfurt API...`);
            
            try {
                const isin = etfData[etf].isin;
                const wkn = etfData[etf].wkn;
                const symbol = etfData[etf].symbol;
                
                // URL de l'API r√©elle de B√∂rse Frankfurt
                const apiUrl = `https://api.boerse-frankfurt.de/v1/data/quote_box/single?isin=${isin}`;
                
                addDebugLog(`ISIN: ${isin} | WKN: ${wkn} | Symbol: ${symbol}`);
                addDebugLog(`API URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    },
                    mode: 'cors'
                });
                
                addDebugLog(`R√©ponse HTTP: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                addDebugLog(`Donn√©es re√ßues pour ${etf}: ${JSON.stringify(data).substring(0, 400)}...`);
                
                // Traitement des donn√©es selon la structure r√©elle de l'API
                // Structure: {"isin":"IE00B4L5Y983","lastPrice":97.95,"changeToPrevDayAbsolute":-1.1180,"changeToPrevDayInPercent":-1.1300,"open":98.878,...}
                if (data && data.lastPrice !== undefined) {
                    const currentPrice = parseFloat(data.lastPrice);
                    const changeAbsolute = parseFloat(data.changeToPrevDayAbsolute || 0);
                    const changePercent = parseFloat(data.changeToPrevDayInPercent || 0);
                    const openPrice = parseFloat(data.open || 0);
                    const timestamp = data.timestampLastPrice || data.timestamp;
                    
                    const result = {
                        price: currentPrice,
                        change: changeAbsolute,
                        changePercent: changePercent,
                        openPrice: openPrice,
                        lastUpdate: new Date().toLocaleTimeString('fr-FR'),
                        timestamp: timestamp,
                        tradingStatus: data.tradingStatus,
                        instrumentStatus: data.instrumentStatus
                    };
                    
                    addDebugLog(`‚úÖ Succ√®s pour ${etf}: ${result.price}‚Ç¨, variation: ${result.changePercent}%`);
                    addDebugLog(`   Prix ouverture: ${result.openPrice}‚Ç¨, Status: ${result.instrumentStatus}`);
                    return result;
                } else {
                    addDebugLog(`‚ùå Structure de donn√©es inattendue pour ${etf}: lastPrice manquant`);
                    addDebugLog(`   Donn√©es re√ßues: ${JSON.stringify(data)}`);
                    throw new Error('Champ lastPrice non trouv√© dans la r√©ponse API');
                }
                
            } catch (error) {
                addDebugLog(`‚ùå Erreur compl√®te pour ${etf}: ${error.message}`);
                
                // Si c'est une erreur CORS, on propose une solution de contournement
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    addDebugLog(`‚ö†Ô∏è Erreur CORS d√©tect√©e - tentative de contournement...`);
                    // Essayer avec un proxy CORS public
                    try {
                        return await fetchWithCORSProxy(etf);
                    } catch (proxyError) {
                        addDebugLog(`‚ùå Proxy CORS aussi √©chou√©: ${proxyError.message}`);
                        throw new Error(`CORS bloqu√©. Utilisez Chrome avec --disable-web-security ou une extension CORS`);
                    }
                }
                throw error;
            }
        }

        // Fonction de contournement CORS avec proxy public
        async function fetchWithCORSProxy(etf) {
            const isin = etfData[etf].isin;
            const originalUrl = `https://api.boerse-frankfurt.de/v1/data/quote_box/single?isin=${isin}`;
            
            // Essayer diff√©rents proxies CORS publics
            const proxies = [
                `https://api.allorigins.win/get?url=${encodeURIComponent(originalUrl)}`,
                `https://cors-anywhere.herokuapp.com/${originalUrl}`,
            ];
            
            for (const proxyUrl of proxies) {
                try {
                    addDebugLog(`Tentative proxy CORS: ${proxyUrl.substring(0, 100)}...`);
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const proxyData = await response.json();
                        // allorigins retourne les donn√©es dans .contents
                        const actualData = proxyData.contents ? JSON.parse(proxyData.contents) : proxyData;
                        
                        if (actualData && actualData.lastPrice !== undefined) {
                            const result = {
                                price: parseFloat(actualData.lastPrice),
                                change: parseFloat(actualData.changeToPrevDayAbsolute || 0),
                                changePercent: parseFloat(actualData.changeToPrevDayInPercent || 0),
                                openPrice: parseFloat(actualData.open || 0),
                                lastUpdate: new Date().toLocaleTimeString('fr-FR'),
                                timestamp: actualData.timestampLastPrice || actualData.timestamp,
                                tradingStatus: actualData.tradingStatus,
                                instrumentStatus: actualData.instrumentStatus
                            };
                            
                            addDebugLog(`‚úÖ Succ√®s via proxy pour ${etf}: ${result.price}‚Ç¨ (${result.changePercent}%)`);
                            return result;
                        }
                    }
                } catch (proxyError) {
                    addDebugLog(`‚ùå Proxy ${proxyUrl.substring(0, 50)}... √©chou√©: ${proxyError.message}`);
                    continue;
                }
            }
            
            throw new Error('Tous les proxies CORS ont √©chou√©');
        }

        // Simulation des donn√©es ETF (remplace l'API r√©elle)
        async function simulateETFData(etf) {
            // Simulation avec des donn√©es r√©alistes bas√©es sur les vrais ETF
            const baseData = {
                IWDA: { basePrice: 75.30, volatility: 0.7 }, // iShares Core MSCI World
                VWCE: { basePrice: 108.50, volatility: 0.8 }, // Vanguard FTSE All-World  
                MEUD: { basePrice: 52.80, volatility: 0.9 }, // Amundi STOXX Europe 600
                IMAE: { basePrice: 41.20, volatility: 1.0 }  // iShares Core MSCI Europe
            };

            const base = baseData[etf];
            const randomVariation = (Math.random() - 0.5) * base.volatility * 2; // -volatility% √† +volatility%
            const currentPrice = base.basePrice * (1 + randomVariation / 100);
            const changeAbsolute = currentPrice - base.basePrice;
            const changePercent = (changeAbsolute / base.basePrice) * 100;

            // Ajouter un d√©lai pour simuler l'appel r√©seau
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));

            return {
                price: parseFloat(currentPrice.toFixed(2)),
                change: parseFloat(changeAbsolute.toFixed(2)),
                changePercent: parseFloat(changePercent.toFixed(2)),
                lastUpdate: new Date().toLocaleTimeString('fr-FR')
            };
        }

        async function testConnection() {
            addDebugLog('=== TEST DE CONNEXION B√ñRSE FRANKFURT API ===');
            addDebugLog('URL test: https://api.boerse-frankfurt.de/v1/data/quote_box/single?isin=IE00BK5BQT80');
            
            try {
                // Test avec VWCE en utilisant la vraie API
                addDebugLog('üîç Test de l\'API avec VWCE (IE00BK5BQT80)...');
                const testData = await fetchETFDataFromBoerseFrankfurt('VWCE');
                addDebugLog(`‚úÖ API Test r√©ussi: ${testData.price}‚Ç¨ (${testData.changePercent}%)`);
                addDebugLog(`   Status: ${testData.instrumentStatus}, Timestamp: ${testData.timestamp}`);
                
                alert(`üéâ CONNEXION API R√âUSSIE !\n\n‚úÖ B√∂rse Frankfurt API fonctionnelle\n‚úÖ VWCE: ${testData.price}‚Ç¨ (${testData.changePercent}%)\n‚úÖ Prix ouverture: ${testData.openPrice}‚Ç¨\n‚úÖ Status: ${testData.instrumentStatus}\n\nVous pouvez maintenant actualiser tous les cours.`);
                
            } catch (error) {
                addDebugLog(`‚ùå Erreur de connexion API: ${error.message}`);
                
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    alert(`‚ùå Probl√®me CORS d√©tect√© !\n\nL'API B√∂rse Frankfurt fonctionne (test√©e manuellement) mais le navigateur bloque les requ√™tes cross-origin.\n\nüîß SOLUTIONS IMM√âDIATES:\n\n1Ô∏è‚É£ Chrome avec CORS d√©sactiv√©:\n   chrome --disable-web-security --user-data-dir=/tmp/chrome_dev\n\n2Ô∏è‚É£ Extension navigateur:\n   - "CORS Unblock" (Chrome)\n   - "CORS Everywhere" (Firefox)\n\n3Ô∏è‚É£ Firefox:\n   about:config ‚Üí security.tls.insecure_fallback_hosts\n\nL'outil va maintenant essayer les proxies CORS automatiquement.`);
                } else {
                    alert(`‚ùå Erreur API !\n\nErreur: ${error.message}\n\nV√©rifiez:\n‚Ä¢ Votre connexion internet\n‚Ä¢ La disponibilit√© de l'API B√∂rse Frankfurt\n‚Ä¢ Les logs de d√©bogage pour plus de d√©tails\n\nAPI test√©e: https://api.boerse-frankfurt.de/v1/data/quote_box/single?isin=IE00BK5BQT80`);
                }
            }
        }

        async function refreshAllData() {
            if (isLoading) return;
            isLoading = true;
            updateApiStatus('loading');
            updateRefreshButton(true);
            
            addDebugLog('=== D√âBUT DU REFRESH COMPLET ===');

            try {
                let successCount = 0;
                
                for (const etf of etfs) {
                    try {
                        addDebugLog(`\n--- Traitement de ${etf} ---`);
                        const data = await fetchETFDataFromBoerseFrankfurt(etf);
                        
                        etfData[etf] = { ...etfData[etf], ...data };
                        successCount++;
                        addDebugLog(`‚úÖ ${etf} r√©cup√©r√© avec succ√®s`);
                        
                        // D√©lai entre les requ√™tes pour √©viter la surcharge
                        if (etf !== etfs[etfs.length - 1]) {
                            addDebugLog('Attente de 300ms...');
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    } catch (error) {
                        addDebugLog(`‚ùå Erreur pour ${etf}: ${error.message}`);
                    }
                }

                document.getElementById('last-refresh').textContent = 
                    `Mise √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;

                addDebugLog(`\n=== R√âSULTATS ===`);
                addDebugLog(`ETFs r√©ussis: ${successCount}/4`);

                if (successCount === 4) {
                    setupAutoRefresh();
                    addDebugLog('‚úÖ Tous les 4 ETFs mis √† jour !');
                } else if (successCount > 0) {
                    addDebugLog('‚ö†Ô∏è Mise √† jour partielle');
                } else {
                    addDebugLog('‚ùå Aucun ETF mis √† jour');
                }

                renderETFTable();
                calculateRecommendation();

            } catch (error) {
                addDebugLog(`‚ùå Erreur g√©n√©rale: ${error.message}`);
            } finally {
                isLoading = false;
                updateRefreshButton(false);
                addDebugLog('=== FIN DU REFRESH ===');
            }
        }

        function updateApiStatus(status) {
            const statusElement = document.getElementById('api-status');
            if (!statusElement) return;
            
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            if (!icon || !text) return;

            statusElement.className = 'flex items-center space-x-2 px-3 py-2 rounded-lg ';

            switch (status) {
                case 'connected':
                    statusElement.className += 'bg-green-50';
                    icon.setAttribute('data-lucide', 'wifi');
                    icon.className = 'w-4 h-4 text-green-600';
                    text.className = 'text-sm font-medium text-green-600';
                    text.textContent = 'B√∂rse Frankfurt OK';
                    break;
                case 'loading':
                    statusElement.className += 'bg-blue-50';
                    icon.setAttribute('data-lucide', 'refresh-cw');
                    icon.className = 'w-4 h-4 text-blue-600 animate-spin';
                    text.className = 'text-sm font-medium text-blue-600';
                    text.textContent = 'Chargement...';
                    break;
                case 'partial':
                    statusElement.className += 'bg-yellow-50';
                    icon.setAttribute('data-lucide', 'alert-triangle');
                    icon.className = 'w-4 h-4 text-yellow-600';
                    text.className = 'text-sm font-medium text-yellow-600';
                    text.textContent = 'Donn√©es Partielles';
                    break;
                case 'error':
                    statusElement.className += 'bg-red-50';
                    icon.setAttribute('data-lucide', 'wifi-off');
                    icon.className = 'w-4 h-4 text-red-600';
                    text.className = 'text-sm font-medium text-red-600';
                    text.textContent = 'Erreur Connexion';
                    break;
                default:
                    statusElement.className += 'bg-red-50';
                    icon.setAttribute('data-lucide', 'wifi-off');
                    icon.className = 'w-4 h-4 text-red-600';
                    text.className = 'text-sm font-medium text-red-600';
                    text.textContent = 'D√©connect√©';
            }
            
            lucide.createIcons();
        }

        function updateRefreshButton(loading) {
            const btn = document.getElementById('refresh-btn');
            if (!btn) return;
            
            const icon = btn.querySelector('i');
            if (!icon) return;
            
            if (loading) {
                btn.disabled = true;
                icon.className = 'w-5 h-5 mr-2 animate-spin';
                icon.setAttribute('data-lucide', 'refresh-cw');
                btn.querySelector('span') || (btn.innerHTML = btn.innerHTML.replace(/Actualiser.*/, 'Chargement...'));
            } else {
                btn.disabled = false;
                icon.className = 'w-5 h-5 mr-2';
                icon.setAttribute('data-lucide', 'refresh-cw');
                btn.innerHTML = '<i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>Actualiser les Cours';
            }
            
            lucide.createIcons();
        }

        function setupAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(refreshAllData, 15 * 60 * 1000); // 15 minutes
            addDebugLog('Auto-refresh configur√© (15 minutes)');
        }

        function renderETFTable() {
            const tbody = document.getElementById('etf-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            etfs.forEach((etf, index) => {
                const data = etfData[etf] || {};
                
                // Calculer le delta bas√© sur les variations
                let delta = null;
                if (currentStock !== etf && 
                    data.changePercent !== null && data.changePercent !== undefined && 
                    etfData[currentStock] && 
                    etfData[currentStock].changePercent !== null && etfData[currentStock].changePercent !== undefined) {
                    delta = etfData[currentStock].changePercent - data.changePercent;
                }

                const row = document.createElement('tr');
                row.className = etf === currentStock ? 'bg-green-50' : (index % 2 === 0 ? 'bg-gray-50' : 'bg-white');

                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-bold text-lg ${etf === currentStock ? 'text-green-600' : 'text-gray-800'}">${etf}</span>
                                <div class="text-xs text-gray-500">${data.name || 'ETF Europ√©en'}</div>
                                <div class="text-xs text-gray-400">ISIN: ${data.isin || ''} | WKN: ${data.wkn || ''}</div>
                            </div>
                            ${etf === currentStock ? '<span class="px-2 py-1 bg-green-600 text-white text-xs rounded-full">D√âTENU</span>' : ''}
                        </div>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="font-bold text-lg">${data.price ? `${data.price.toFixed(2)}‚Ç¨` : '-'}</span>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        ${data.changePercent !== null && data.changePercent !== undefined ? 
                            `<span class="font-semibold ${data.changePercent >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${data.changePercent >= 0 ? '+' : ''}${data.changePercent.toFixed(2)}%
                            </span>
                            <div class="text-xs text-gray-500">
                                ${data.change ? `(${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}‚Ç¨)` : ''}
                            </div>` :
                            '<span class="text-gray-400">-</span>'
                        }
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        ${etf === currentStock ? 
                            '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">R√âF√âRENCE</span>' :
                            delta !== null ? 
                                `<span class="font-bold text-xl ${delta >= 0.5 ? 'text-green-600 animate-pulse' : 'text-gray-600'}">
                                    ${delta >= 0 ? '+' : ''}${delta.toFixed(2)}%
                                    ${delta >= 0.5 ? '<span class="ml-1">üöÄ</span>' : ''}
                                </span>
                                <div class="text-xs text-gray-500">√©cart performances</div>` :
                                '<span class="text-gray-400">-</span>'
                        }
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        ${data.lastUpdate ? 
                            `<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">‚úì ${data.lastUpdate}</span>` :
                            '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">‚úó Pas de donn√©es</span>'
                        }
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function calculateDeltas() {
            if (!etfData[currentStock] || 
                etfData[currentStock].changePercent === null || 
                etfData[currentStock].changePercent === undefined) {
                return [];
            }

            const currentVariation = etfData[currentStock].changePercent;
            const deltas = [];

            etfs.forEach(etf => {
                if (etf === currentStock) return;
                
                if (!etfData[etf] || 
                    etfData[etf].changePercent === null || 
                    etfData[etf].changePercent === undefined) {
                    return;
                }

                const otherVariation = etfData[etf].changePercent;
                const delta = currentVariation - otherVariation;
                
                deltas.push({
                    targetEtf: etf,
                    delta,
                    currentVariation,
                    targetVariation: otherVariation,
                    currentPrice: etfData[currentStock].price || 0,
                    targetPrice: etfData[etf].price || 0
                });
            });

            return deltas.sort((a, b) => b.delta - a.delta);
        }

        function calculateRecommendation() {
            const recommendationSection = document.getElementById('recommendation-section');
            const deltasSection = document.getElementById('deltas-section');
            
            if (!etfData[currentStock].price) {
                recommendationSection.style.display = 'none';
                deltasSection.style.display = 'none';
                return;
            }

            const deltas = calculateDeltas();
            if (deltas.length === 0) {
                recommendationSection.style.display = 'none';
                deltasSection.style.display = 'none';
                return;
            }

            const bestDelta = deltas.find(d => d.delta > 0.5);
            
            // V√©rifier si c'est un nouveau signal de trade
            const currentSignal = bestDelta ? `${currentStock}->${bestDelta.targetEtf}` : null;
            if (bestDelta && currentSignal !== lastTradeSignal) {
                // Nouveau signal d√©tect√© - envoyer notification
                lastTradeSignal = currentSignal;
                const gainPotentiel = ((portfolioValue * bestDelta.delta) / 100) - 50;
                
                showNotification(
                    'üö® SIGNAL DE TRADE D√âTECT√â !',
                    `${currentStock} ‚Üí ${bestDelta.targetEtf}\nDelta: +${bestDelta.delta.toFixed(2)}%\nGain estim√©: +${gainPotentiel.toFixed(0)}‚Ç¨`,
                    'trade'
                );
                
                addDebugLog(`üö® NOTIFICATION: Signal de trade ${currentSignal} envoy√©e`);
            } else if (!bestDelta && lastTradeSignal) {
                // Plus de signal - r√©initialiser
                lastTradeSignal = null;
                addDebugLog('üìä Plus de signal de trade actif');
            }
            
            recommendationSection.style.display = 'block';
            deltasSection.style.display = 'block';

            renderRecommendation(bestDelta, deltas);
            renderDeltasTable(deltas);
        }

        function renderRecommendation(bestDelta, allDeltas) {
            const content = document.getElementById('recommendation-content');
            
            if (bestDelta) {
                const expectedGain = (portfolioValue * bestDelta.delta / 100) - 50;
                
                content.innerHTML = `
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-6">
                        <div class="flex items-center justify-center mb-4">
                            <div class="bg-green-600 text-white px-6 py-3 rounded-full text-xl font-bold animate-pulse">
                                üö® SIGNAL DE TRADE D√âTECT√â !
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg p-4 border border-green-200">
                                <h3 class="font-semibold text-green-800 mb-3">üèõÔ∏è Action Imm√©diate (B√∂rse Frankfurt)</h3>
                                <div class="text-2xl font-bold text-green-700 mb-2">VENDRE ${currentStock} et ACHETER ${bestDelta.targetEtf}</div>
                                <div class="text-sm text-green-600 space-y-1">
                                    <div>Delta de performance: <span class="font-semibold">${bestDelta.delta.toFixed(2)}%</span> (&gt; 0.5%)</div>
                                    <div>${currentStock}: <span class="font-semibold ${bestDelta.currentVariation >= 0 ? 'text-green-600' : 'text-red-600'}">${bestDelta.currentVariation >= 0 ? '+' : ''}${bestDelta.currentVariation.toFixed(2)}%</span></div>
                                    <div>${bestDelta.targetEtf}: <span class="font-semibold ${bestDelta.targetVariation >= 0 ? 'text-green-600' : 'text-red-600'}">${bestDelta.targetVariation >= 0 ? '+' : ''}${bestDelta.targetVariation.toFixed(2)}%</span></div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 border border-green-200">
                                <h3 class="font-semibold text-green-800 mb-3">üí∞ Impact Financier</h3>
                                <div class="space-y-3">
                                    <div class="bg-blue-50 p-3 rounded">
                                        <div class="text-sm text-blue-700">Gain potentiel:</div>
                                        <div class="text-lg font-bold text-blue-600">+${((portfolioValue * bestDelta.delta) / 100).toFixed(0)}‚Ç¨</div>
                                    </div>
                                    <div class="bg-red-50 p-3 rounded">
                                        <div class="text-sm text-red-700">Frais de trading:</div>
                                        <div class="text-lg font-bold text-red-600">-50‚Ç¨</div>
                                    </div>
                                    <div class="bg-green-50 p-3 rounded">
                                        <div class="text-sm text-green-700">Gain net estim√©:</div>
                                        <div class="text-xl font-bold text-green-600">+${expectedGain.toFixed(0)}‚Ç¨</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const topDelta = allDeltas[0];
                content.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl p-6">
                        <div class="flex items-center justify-center mb-4">
                            <div class="bg-yellow-600 text-white px-6 py-3 rounded-full text-xl font-bold flex items-center">
                                <i data-lucide="check-circle" class="w-6 h-6 mr-2"></i>
                                PATIENCE - CONSERVER
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-700 mb-2">CONSERVER ${currentStock}</div>
                            <div class="text-yellow-600">Meilleur delta: ${topDelta ? topDelta.delta.toFixed(2) : '0.00'}% (< 0.5%)</div>
                            <div class="text-sm text-yellow-600 mt-2">Donn√©es via B√∂rse Frankfurt</div>
                        </div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        function renderDeltasTable(deltas) {
            const tbody = document.getElementById('deltas-table-body');
            tbody.innerHTML = '';

            deltas.forEach((delta, index) => {
                const potentialGain = (portfolioValue * delta.delta / 100) - 50;
                const row = document.createElement('tr');
                row.className = delta.delta > 0.5 ? 'bg-green-50' : (index % 2 === 0 ? 'bg-gray-50' : 'bg-white');

                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3 font-semibold">
                        #${index + 1}
                        ${delta.delta > 0.5 ? '<span class="ml-2">üéØ</span>' : ''}
                    </td>
                    <td class="border border-gray-300 px-4 py-3">
                        <div>
                            <span class="font-semibold">${currentStock} ‚Üí ${delta.targetEtf}</span>
                            <div class="text-xs text-gray-500">
                                ${currentStock}: ${delta.currentVariation >= 0 ? '+' : ''}${delta.currentVariation.toFixed(2)}% ‚Üí 
                                ${delta.targetEtf}: ${delta.targetVariation >= 0 ? '+' : ''}${delta.targetVariation.toFixed(2)}%
                            </div>
                            <div class="text-xs text-blue-600">Via B√∂rse Frankfurt</div>
                        </div>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center font-bold text-xl ${delta.delta > 0.5 ? 'text-green-600' : 'text-gray-600'}">
                        ${delta.delta >= 0 ? '+' : ''}${delta.delta.toFixed(2)}%
                        <div class="text-xs text-gray-500 font-normal">√©cart performance</div>
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        ${delta.delta > 0.5 ? 
                            '<span class="px-3 py-2 bg-green-100 text-green-800 rounded-full font-bold animate-pulse">üöÄ TRADER MAINTENANT</span>' :
                            '<span class="px-3 py-2 bg-gray-100 text-gray-600 rounded-full">‚è≥ Attendre</span>'
                        }
                    </td>
                    <td class="border border-gray-300 px-4 py-3 text-center font-bold ${potentialGain > 0 ? 'text-green-600' : 'text-red-600'}">
                        ${potentialGain > 0 ? '+' : ''}${potentialGain.toFixed(0)}‚Ç¨
                    </td>
                `;

                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>